# 后台代码自查方案

## 📋 基础信息
- 实际的端口配置是：
本地开发：http://localhost:5270 (命令行指定)
生产部署：http://47.92.95.129:9999 (实际部署端口)
- **开发环境代理**: `http://localhost:8080` → `/dev-api`

## 🔍 API接口自查清单

### 1. 核心认证接口

#### 1.1 登录接口 `/login`
```http
POST /login
Content-Type: application/json
```

**前端发送数据**:
```json
{
  "username": "admin",
  "password": "encrypted_password",
  "code": "验证码",
  "uuid": "验证码UUID"
}
```

**后台应返回**:
```json
{
  "code": 200,
  "msg": "操作成功",
  "token": "eyJhbGciOiJIUzUxMiJ9..."
}
```

**⚠️ 检查点**:
- [ ] 接口路径是否为 `/login`
- [ ] 是否支持 POST 方法
- [ ] 返回数据包含 `token` 字段
- [ ] 状态码为 200 表示成功

#### 1.2 获取用户信息接口 `/getInfo`
```http
GET /getInfo
Authorization: Bearer {token}
```

**后台应返回**:
```json
{
  "code": 200,
  "msg": "操作成功",
  "user": {
    "userId": 1,
    "userName": "admin",
    "nickName": "管理员",
    "email": "admin@example.com",
    "avatar": "/upload/avatar.jpg"
  },
  "roles": ["admin"],
  "permissions": ["*:*:*"]
}
```

**⚠️ 检查点**:
- [ ] 接口路径是否为 `/getInfo`
- [ ] 是否支持 GET 方法
- [ ] 验证 Authorization Bearer Token
- [ ] 返回结构包含 `user`, `roles`, `permissions` 字段
- [ ] `roles` 必须是数组格式
- [ ] `user.avatar` 可以为空或相对路径

#### 1.3 退出登录接口 `/logout`
```http
GET /logout
Authorization: Bearer {token}
```

**后台应返回**:
```json
{
  "code": 200,
  "msg": "操作成功"
}
```

**⚠️ 检查点**:
- [ ] 接口路径是否为 `/logout`
- [ ] 是否支持 GET 方法 (前端已修改为GET)
- [ ] 接收并验证token
- [ ] 清除服务端session/token

#### 1.4 验证码接口 `/captchaImage`
```http
GET /captchaImage
```

**后台应返回**:
```json
{
  "code": 200,
  "msg": "操作成功",
  "captchaEnabled": true,
  "img": "iVBORw0KGgoAAAANSUhEUgAAAG...", // base64编码的图片数据
  "uuid": "unique-uuid-string"
}
```

**⚠️ 检查点**:
- [ ] 接口路径是否为 `/captchaImage`
- [ ] 是否支持 GET 方法
- [ ] 返回 `img` 字段包含base64图片数据
- [ ] 返回 `uuid` 用于验证码校验
- [ ] `captchaEnabled` 字段控制是否启用验证码

### 2. 推荐数据接口

#### 2.1 服务主体列表 `/public/servicer/list`
```http
GET /public/servicer/list?pageNum=1&pageSize=10
```

**后台应返回**:
```json
{
  "code": 200,
  "msg": "操作成功",
  "rows": [
    {
      "id": 1,
      "name": "服务主体名称",
      "typeId": "1",
      "pictureUrls": "image1.jpg,image2.jpg",
      "description": "服务描述"
    }
  ],
  "total": 100
}
```

**⚠️ 检查点**:
- [ ] 接口路径是否为 `/public/servicer/list`
- [ ] 是否支持 GET 方法
- [ ] 返回结构包含 `rows` (数据数组) 和 `total` (总数)
- [ ] 支持分页参数 `pageNum`, `pageSize`

#### 2.2 服务标准列表 `/public/standards/list`
```http
GET /public/standards/list?pageNum=1&pageSize=10
```

**后台应返回**:
```json
{
  "code": 200,
  "msg": "操作成功",
  "rows": [
    {
      "id": 1,
      "fileName": "标准文件名",
      "coverImage": "cover.jpg",
      "issuingAgency": "发布机构",
      "attachments": "file1.pdf,file2.pdf"
    }
  ],
  "total": 50
}
```

**⚠️ 检查点**:
- [ ] 接口路径是否为 `/public/standards/list`
- [ ] 是否支持 GET 方法
- [ ] 返回结构包含 `rows` 和 `total` 字段
- [ ] 支持分页参数

### 3. 手机验证码接口

#### 3.1 发送验证码 `/sendPhoneCode`
```http
POST /sendPhoneCode
Content-Type: application/json
```

**前端发送数据**:
```json
{
  "phone": "13888888888"
}
```

#### 3.2 手机登录 `/phoneLogin`
```http
POST /phoneLogin
Content-Type: application/json
```

**前端发送数据**:
```json
{
  "phone": "13888888888",
  "phoneCode": "123456"
}
```

## 🔧 通用响应格式规范

### 成功响应
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {} // 具体数据
}
```

### 错误响应
```json
{
  "code": 500,
  "msg": "具体错误信息"
}
```

### 前端处理的错误码
- `401`: 未授权/token过期 → 自动跳转登录
- `500`: 服务器错误 → 显示错误消息
- `601`: 业务警告 → 显示警告消息
- `其他非200`: 显示通知错误

## 🌐 CORS跨域配置

### Spring Boot配置示例
```java
@Configuration
public class CorsConfig {
    @Bean
    public CorsFilter corsFilter() {
        CorsConfiguration config = new CorsConfiguration();
        config.addAllowedOrigin("http://47.92.95.129:9999");
        config.addAllowedOriginPattern("*");
        config.addAllowedMethod("*");
        config.addAllowedHeader("*");
        config.setAllowCredentials(true);
        
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", config);
        return new CorsFilter(source);
    }
}
```

## 🔐 认证授权配置

### JWT Token配置
- **请求头**: `Authorization: Bearer {token}`
- **Token前缀**: `Bearer `
- **Token超时**: 建议30分钟-2小时

### 角色权限
前端期望的角色名称：
- `admin` 或 `ROLE_ADMIN`: 超级管理员
- `servicer` 或 `ROLE_SERVICER`: 服务主体
- `producter` 或 `ROLE_PRODUCTER`: 生产主体

## 📁 静态资源配置

### 文件上传路径
- **头像上传**: `/upload/avatar/`
- **标准文件**: `/upload/standards/`
- **图片资源**: `/upload/images/`

### 静态资源访问
```java
@Configuration
public class WebMvcConfig implements WebMvcConfigurer {
    @Override
    public void addResourceHandlers(ResourceHandlerRegistry registry) {
        registry.addResourceHandler("/upload/**")
                .addResourceLocations("file:./upload/");
    }
}
```

## 🗃️ 数据库字段检查

### 用户表字段
```sql
CREATE TABLE sys_user (
    user_id BIGINT PRIMARY KEY,
    user_name VARCHAR(30) NOT NULL,
    nick_name VARCHAR(30),
    email VARCHAR(50),
    avatar VARCHAR(100),
    status CHAR(1) DEFAULT '0'
);
```

### 角色表关联
```sql
-- 确保用户角色关联表正确
SELECT u.user_name, r.role_key 
FROM sys_user u 
LEFT JOIN sys_user_role ur ON u.user_id = ur.user_id
LEFT JOIN sys_role r ON ur.role_id = r.role_id
WHERE u.user_name = 'admin';
```

## 🚀 部署检查清单

### 1. 应用配置
- [ ] 端口配置: `server.port=9999`
- [ ] 数据库连接正常
- [ ] Redis连接正常(如使用)
- [ ] 文件上传目录存在且有写权限

### 2. 安全配置
- [ ] HTTPS配置(生产环境推荐)
- [ ] 跨域配置正确
- [ ] 安全头配置

### 3. 日志配置
建议添加接口访问日志：
```java
@Slf4j
@RestController
public class AuthController {
    
    @PostMapping("/login")
    public Result login(@RequestBody LoginRequest request) {
        log.info("登录请求: username={}", request.getUsername());
        // 登录逻辑
    }
    
    @GetMapping("/getInfo")
    public Result getInfo(HttpServletRequest request) {
        String token = request.getHeader("Authorization");
        log.info("获取用户信息请求: token={}", token);
        // 获取用户信息逻辑
    }
}
```

## 🐛 常见问题排查

### 1. 验证码不显示
- 检查 `/captchaImage` 接口返回的 `img` 字段
- 确认返回的是base64编码的图片数据
- 检查验证码生成库是否正常工作

### 2. 用户信息获取失败
- 检查token验证逻辑
- 确认返回的数据结构包含 `user`, `roles`, `permissions`
- 检查角色查询SQL是否正确

### 3. 推荐列表不显示
- 确认返回数据格式为 `{rows: [], total: 0}`
- 检查分页参数处理
- 确认数据库中有测试数据

### 4. 后台管理访问失败
- 检查用户角色是否包含 `admin`
- 确认动态路由接口 `/getRouters` 返回正确
- 检查权限过滤器配置

## 🧪 接口测试工具

使用以下工具测试接口：

### Postman测试
```bash
# 1. 获取验证码
GET http://47.92.95.129:9999/captchaImage

# 2. 登录
POST http://47.92.95.129:9999/login
{
  "username": "admin",
  "password": "admin123",
  "code": "1234",
  "uuid": "uuid-from-captcha"
}

# 3. 获取用户信息
GET http://47.92.95.129:9999/getInfo
Authorization: Bearer your-token-here
```

### curl测试
```bash
# 测试验证码接口
curl -X GET "http://47.92.95.129:9999/captchaImage"

# 测试登录接口
curl -X POST "http://47.92.95.129:9999/login" \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'
```

---

**⚡ 快速检查命令**
1. 检查应用是否启动: `curl http://47.92.95.129:9999/captchaImage`
2. 检查跨域配置: 浏览器F12查看Response Headers
3. 检查日志: `tail -f logs/application.log`
4. 检查数据库连接: 查看启动日志中的数据库连接信息

按此清单逐项检查，应该能快速定位和解决后台代码问题！
